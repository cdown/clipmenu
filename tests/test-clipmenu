#!/usr/bin/env bash

set -x
set -e
set -o pipefail

# shellcheck disable=SC1091
source "${BASH_SOURCE[0]%/*}/setup.sh"

temp="${tempdir?}/out"

cleanup_pre() {
    if [[ -n "${temp:-}" ]] && [[ -f "$temp" ]]; then
        cat "$temp"
    fi
}

rm -rf "${dir?}"
mkdir -p "$dir"

cat > "${cache_file?}" << 'EOF'
1234 Selected text. (2 lines)
1235 Selected text 2. (2 lines)
EOF

cat > "$dir/$(cksum <<< 'Selected text. (2 lines)')" << 'EOF'
Selected text.
Yes, it's selected text.
EOF

### TESTS ###

clipmenu --foo bar > "$temp" 2>&1

# Arguments are transparently passed to dmenu
grep -Fxq 'dmenu args: -l 8 --foo bar' "$temp"

# Output from cache file should get to dmenu, reversed
grep -Fxq 'dmenu line 1 stdin: Selected text 2. (2 lines)' "$temp"
grep -Fxq 'dmenu line 2 stdin: Selected text. (2 lines)' "$temp"

# xsel should copy both to clipboard *and* primary
grep -Fxq 'xsel args: --logfile /dev/null -i --clipboard' "$temp"
grep -Fxq 'xsel args: --logfile /dev/null -i --primary' "$temp"

grep -Fxq 'xsel line 1 stdin: Selected text.' "$temp"
grep -Fxq "xsel line 2 stdin: Yes, it's selected text." "$temp"

CM_LAUNCHER=rofi clipmenu --foo bar > "$temp" 2>&1

# We have a special case to add -dmenu for rofi
grep -Fxq 'rofi args: -l 8 -dmenu -p clipmenu --foo bar' "$temp"
